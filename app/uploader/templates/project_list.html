{% import "macros.html" as macros %}
{% extends "item_list.html" %}
{% block title %}Projects{% endblock %}
{% block page_header %}
    {{ macros.breadcrumbs([("", "Projects")]) }}
{% endblock %}
{% block creation_header %}Create new project{% endblock %}

{% block creation_form %}
    <form method="POST" enctype="multipart/form-data" class="form-inline"
        role="form" id="createProject">
        {{ macros.render_errors(create_form.name.errors) }}
        {{ create_form.hidden_tag() }}
        {{ macros.render_field(create_form.name, label_class="sr-only",
            show_errors=False) }}
        {{ create_form.create_button(class="btn btn-primary",
            icon="glyphicon-ok") }}
    </form>
{% endblock %}

{% block list_header %}Existing projects{% endblock %}
{% block list_form %}
    {% if projects %}
            <table class="table table-striped table-hover buttons click-anywhere">
                <thead>
                    <tr>
                        <th class="fitted">
                        </th>
                        <th class="emph">
                            Project Name
                        </th>
                        <th class="fitted">
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects %}
                        <tr>
                            <td class="fitted">
                                {% if project.status == 0 %}
                                    <a href="{{ url_for("uploader.project_show",
                                    project_id=project.id) }}", class="btn btn-default">
                                    <span class="glyphicon glyphicon-plus"></span>
                                    Add documents
                                </a>
                                {% endif %}
                                {% if project.status == 2 %}
                                <a class="btn btn-primary {{ analyze_button_class }}" role="button"
                                    href="{{url_for('wordseer.ext_app', project_id=project.id)}}"}>
                                    <span class="glyphicon glyphicon-search"></span>
                                    Explore data
                                </a>
                                {% endif %}
                            </td>
                            <td class="emph">
                                <label for="{{ project.id }}">
                                        {{ project.name }}
                                    </a>
                                </label>
                            </td>
                            <td class="fitted">
                                {% if project.status > 0 %}
                                <a href="{{ url_for("uploader.project_show",
                                project_id=project.id) }}", class="btn btn-default">
                                <span class="glyphicon glyphicon-info-sign"></span>
                                    View logs
                                </a>
                                {% endif %}
                                
                            </td>
                            <td class="fitted">
                                <a href="{{ url_for("uploader.project_show",
                                    project_id=project.id) }}", class="btn btn-danger">
                                    <span class="glyphicon glyphicon-remove"></span>
                                    Delete
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        
    {% else %}
        <p>You own no projects.</p>
    {% endif %}
{% endblock %}
{% block toplevel %}
    {{ macros.modal_confirmation() }}
{% endblock %}

{% block scripts %}
    <script type="text/javascript">
    $(document).ready(function(){
        $("form#createProject").submit(function(e){
            e.preventDefault();
            var project_name = $(e.currentTarget).find("#name").val(),
                csrf_token = $(e.currentTarget).find("#csrf_token").val(),
                request = $.post("{{ url_for("uploader.project_create")}}", {name: project_name, csrf_token: csrf_token});
            request.done(function(resp){
                var data = $.parseJSON(resp);
                window.location = "{{ url_for("uploader.project_list") }}" + data.project_id;
            }).fail(function(data){
                console.log("Project creation failed", data);
                // TODO: real error handling
            });
        })
    })
    </script>
{% endblock %}
